<!DOCTYPE html>
<html lang="zh">
  <head>
    <title>松果网</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="http://cdnjs.bootcss.com/ajax/libs/twitter-bootstrap/2.3.2/css/bootstrap.min.css" rel="stylesheet">
	<link href="http://cdnjs.bootcss.com/ajax/libs/twitter-bootstrap/2.3.2/css/bootstrap-responsive.min.css" rel="stylesheet">
    <link href="css/main.css" rel="stylesheet">
  </head>
  <body>
    <div class="navbar navbar-inverse navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">
          <button type="button" class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="brand" href="#">松果网</a>
          <div class="nav-collapse collapse">
            <ul class="nav">
              <li><a href="activation.jsp">激活设备</a></li>
              <li><a href="/j_spring_security_logout">退出</a></li>
            </ul>
          </div>
        </div>
      </div>
    </div>
	<header class="jumbotron subhead">
  	  <div class="container">
    	<h1>管理控制台</h1>
    	<p id="identity" class="lead"></p>
      </div>
	</header>
	<div id="editModel" class="modal hide fade">
  	  <div class="modal-header">
    	<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
    	<h3>修改设备</h3>
  	  </div>
  	  <div class="modal-body"><form id="editDevice" class="form-horizontal" method="post" action="#">
		<div class="input-prepend">
		  <span class="add-on"><i class="icon-pencil"></i></span> 
		  <input type="text" id="devicename" class="input-xlarge" name="devicename" placeholder="设备名称">
		</div>
  	  </div>
  	  <div class="modal-footer">
    	<button type="submit" class="btn btn-success">确定</button></form>
    	<button class="btn btn-success" data-dismiss="modal" aria-hidden="true">取消</button>
  	  </div>
	</div>
	<div id="deleteModel" class="modal hide fade">
  	  <div class="modal-header">
    	<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
    	<h3>删除设备</h3>
  	  </div>
  	  <div class="modal-body">
  	    <p>确定删除吗？</p>
  	  </div>
  	  <div class="modal-footer">
    	<button id="deleteDevice" class="btn btn-success">确定</button>
    	<button class="btn btn-success" data-dismiss="modal" aria-hidden="true">取消</button>
  	  </div>
	</div>
    <div class="container">
  	  <div class="marketing">
    	<h1>设备管理</h1>
    	<p class="marketing-byline">探索未知的智能世界，感知数据的力量!</p>
    	<p id="selectedCode" class="hide"></p>
    	<div class="row-fluid">
      	  <div id="map_canvas"></div>
        </div>
      </div>
    </div>
    <footer class="footer">
      <div class="container">
        <p>&copy; 2013 北京松果科技有限公司</p>
        <ul class="footer-links">
          <li><a href="#">关于我们</a></li>
          <li class="muted">·</li>
          <li><a href="#">在线帮助</a></li>
          <li class="muted">·</li>
          <li><a href="#">隐私条款</a></li>
          <li class="muted">·</li>
          <li><a href="#">用户协议</a></li>
        </ul>
        <p><a href="http://www.miitbeian.gov.cn/" target="_blank">京ICP备13022507号</a></p>
      </div>
    </footer>
	<script src="http://cdnjs.bootcss.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script src="http://cdnjs.bootcss.com/ajax/libs/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
    <script src="http://ajax.aspnetcdn.com/ajax/jquery.validate/1.11.1/jquery.validate.min.js"></script>
	<script src="http://ajax.aspnetcdn.com/ajax/jquery.validate/1.11.1/localization/messages_zh.js"></script>
    <script src="http://maps.googleapis.com/maps/api/js?key=AIzaSyBKkEdoXQxDyl3OKTnMjkvRX-HzOxmsxi8&sensor=false"></script>
    <script src="http://gomap.googlecode.com/files/jquery.gomap-1.3.2.min.js"></script>
    <script src="js/jquery.scrollUp.min.js"></script>
    <script src="js/jquery.html5storage.min.js"></script>
    <script src="js/markerclusterer.min.js"></script>
    <script type="text/javascript">
      
    	$(document).ready(function() {
    	
			$.scrollUp({
				scrollName: 'scrollUp', 
	    		topDistance: '300', 
	    		topSpeed: 300, 
	    		animation: 'fade', 
	    		animationInSpeed: 200, 
	    		animationOutSpeed: 200, 
	    		scrollText: '', 
	    		activeOverlay: false 
			});
			
			$("#editDevice").validate({
				rules : {
					devicename : {
						required : true
					}
				},
				submitHandler : function() {
					$("#editModel").modal("hide");
					getDeviceId($("#selectedCode").text(), updateDevice);
		        }
			});
			
			$("#deleteDevice").on("click", function() {
				$("#deleteModel").modal("hide");
				getDeviceId($("#selectedCode").text(), deleteDevice);
			});
			
			$("#identity").text("欢迎" + $.sessionStorage.getItem("username") + "，开始管理你的设备吧！");
			
			$("#map_canvas").goMap({
				latitude: 39.905841, 
		        longitude: 116.391596, 
		        zoom: 8,
				maptype: 'ROADMAP',
				hideByClick: false
			});
			
			$.goMap.ready(function() {
				getUserId(new MarkerClusterer($.goMap.map));
			});
	
		});
    	
    	function updateDevice(id) {
    		$.ajax({
		    	type : "PUT",
		    	url : "/rest/device/" + id,
		    	contentType : "application/json; charset=utf-8",
		    	data : "{\"name\":\"" + $("#devicename").val() + "\"}",
		    	username : $.sessionStorage.getItem("username"),
		    	password : $.sessionStorage.getItem("password")
			});
    	}
    	
    	function deleteDevice(id) {
    		$.ajax({
		    	type : "DELETE",
		    	url : "/rest/device/" + id,
		    	username : $.sessionStorage.getItem("username"),
		    	password : $.sessionStorage.getItem("password")
			});
    	}
    	
    	function getUserId(markerClusterer) {
    		$.ajax({
		    	type : "GET",
		    	url : "/rest/user/search/names?name=" + $.sessionStorage.getItem("username"),
		    	dataType : "json",
		    	username : $.sessionStorage.getItem("username"),
		    	password : $.sessionStorage.getItem("password"),
		    	success : function(data) {
		    		var href = data.results[0]._links[2].href;
		    		getDevicesByUserId(markerClusterer, href.substring(href.lastIndexOf("/") + 1));
		    	}
			});
    	}
    	
    	function getDevicesByUserId(markerClusterer, id) {
    		$.sessionStorage.setItem("userId", id);
    		$.ajax({
	    		type : "GET",
	    		url : "/rest/user/" + id + "/devices",
	    		dataType : "json",
	    		username : $.sessionStorage.getItem("username"),
	    		password : $.sessionStorage.getItem("password"),
	    		success : function(data) {
	    			var links = data._links;
	    			if(links.length > 0) {
	    				for(var i = 0; i < links.length; i++) {
	    					getDeviceById(markerClusterer, links[i].href);
	    				}	    				
	    			}
	    		}
			});
    	}
    	
    	function getDeviceById(markerClusterer, url) {
    		$.ajax({
	    		type : "GET",
	    		url : url,
	    		dataType : "json",
	    		username : $.sessionStorage.getItem("username"),
	    		password : $.sessionStorage.getItem("password"),
	    		success : function(data) {
	    			getDeviceLocation(markerClusterer, data.name, data.code);
	    		}
			});
    	}
    	
    	function getDeviceLocation(markerClusterer, name, code) {
    		$.ajax({
	    		type : "GET",
	    		url : "/rest/m/device/search/location/codes?code=" + code,
	    		dataType : "json",
	    		username : $.sessionStorage.getItem("username"),
	    		password : $.sessionStorage.getItem("password"),
	    		success : function(data) {	
	    			addDeviceToMap(markerClusterer, data.lat, data.lng, name, code);
	    		}
			});
    	}
    	
    	function addDeviceToMap(markerClusterer, latitude, longitude, name, code) { 
    		$("#map_canvas").before(
    			'<div id="info_' + code + '" class="hide">'+
    				'<p>' + name + '</p>'+
    				'<ul class="nav nav-pills">'+
    					'<li><a data-toggle="modal" data-target="#editModel"><i class="icon-edit"></i> 修改</a></li>'+
    					'<li><a data-toggle="modal" data-target="#deleteModel"><i class="icon-remove"></i> 删除</a></li>'+ 
    				'</ul>'+
    				'<table id="' + code + '" class="table table-hover">'+
    					'<tbody></tbody>'+
    				'</table>'+
    			'</div>'
    		);
    		$.goMap.createMarker({  
    			id: code,
            	latitude: latitude, 
            	longitude: longitude, 
                title: name,
                html: {
                	id: '#info_' + code
                }
            });  
    		$.goMap.createListener({type:'marker', marker:code}, 'click', function() { 
    			$("#selectedCode").text(code);
    	    }); 
    		getDeviceId(code, getVariablesByDeviceId);  
    		markerClusterer.addMarker($($.goMap.mapId).data(code));
    	}
    	
    	function getDeviceId(code, callback) {
    		$.ajax({
		    	type : "GET",
		    	url : "/rest/device/search/codes?code=" + code,
		    	dataType : "json",
		    	username : $.sessionStorage.getItem("username"),
		    	password : $.sessionStorage.getItem("password"),
		    	success : function(data) {
		    		var href = data.results[0]._links[2].href;
		    		callback(href.substring(href.lastIndexOf("/") + 1), code);
		    	}
			});
    	}
    	
    	function getVariablesByDeviceId(id, code) {
    		$.ajax({
	    		type : "GET",
	    		url : "/rest/device/" + id + "/variables",
	    		dataType : "json",
	    		username : $.sessionStorage.getItem("username"),
	    		password : $.sessionStorage.getItem("password"),
	    		success : function(data) {
	    			var links = data._links;
	    			if(links.length > 0) {
	    				for(var i = 0; i < links.length; i++) {
	    					getVariableById(links[i].href, code);
	    				}	    				
	    			}
	    		}
			});
    	}
    	
    	function getVariableById(url, code) {
    		$.ajax({
	    		type : "GET",
	    		url : url,
	    		dataType : "json",
	    		username : $.sessionStorage.getItem("username"),
	    		password : $.sessionStorage.getItem("password"),
	    		success : function(data) {
	    			$("#" + code + " tbody").append(
	    				'<tr><td>' + data.name + '</td><td></td><td>'+  
	    				'<a href="#"><i class="icon-search"></i> 查询 </a>'+
	            		'<a href="#"><i class="icon-wrench"></i> 设置</a>'+
	            		'</td></tr>'
	            	);	
	    		}
			});
    	}
    	
    </script>
  </body>
</html>